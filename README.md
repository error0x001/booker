![ci](https://github.com/error0x001/booker/actions/workflows/ci.yaml/badge.svg)
![cd](https://github.com/error0x001/booker/actions/workflows/cd.yaml/badge.svg)

# Прототип сервиса бронирования отелей

Сервис представляет собой API с двумя эндпоинтами, которые необходимы для формирования брони:

1. GET `/availability` - поиск доступности

| Параметр | Тип              | Описание             |
|----------|------------------|----------------------|
| hotel_id | string           | id отеля             |
| room_id  | string           | id категории комнаты |
| from     | datetime RFC3339 | дата заезда          |
| to       | datetime RFC3339 | дата выздеа          |

Пример запроса:

```sh
curl --location --request GET \
'http://booker.ddns.net/availability?hotel_id=reddison&room_id=lux&from=2024-07-03T00:00:00Z&to=2024-07-10T00:00:00Z'
```

2. POST `/orders` - создание брони

| Параметр | Тип              | Описание             |
|----------|------------------|----------------------|
| hotel_id | string           | id отеля             |
| room_id  | string           | id категории комнаты |
| from     | datetime RFC3339 | дата заезда          |
| to       | datetime RFC3339 | дата выздеа          |
| email    | string           | почта гостя          |

Пример запроса:

```sh
curl --location --request POST 'booker.ddns.net/orders' \
--header 'Content-Type: application/json' \
--data-raw '{
    "hotel_id": "reddison",
    "room_id": "lux",
    "email": "guest@mail.ru",
    "from": "2024-07-08T00:00:00Z",
    "to": "2024-07-09T00:00:00Z"
}'
```

## Проблемы первоначального решения (от простого к сложному)

1. Нет никакой структуры проекта - все в одном файле
2. Нет версионирования api. В будущем скорей всего создаст проблемы с доработками или созданием новых эндпоинтов -
   придется придумывать новый нейминг или подключать версионирование и получить не консистентные маршруты в сервисе
3. Нет обработки ошибок, нет проверки методов, которые приходят в конечный эндпоинт
4. Нет валидации данных. Нам приходит запрос, мы идем что-то бронировать, тем самым нагружать систему, возможно,
   совершенно невалидными данными
5. Нет консистентности формата ответа сервиса - в случае ошибки мы отдаем сырой текст, а в случае валидного ответа json
   Приятнее работать с одним форматом данных, клиентам будет проще писать обработку, если мы в любом случае работаем с
   json
6. Совершенно нет слоев. Есть эндпоинт, в котором все смешано в одну кучу - запрос, обращение к хранилищу, результат.
   Как поддерживать? Как писать юнит-тесты?
7. Нет юнит-тестов на сложные механики (расчет остатков, бронь)
8. Нет никакой конфигурации приложения, все "прибито" гвоздями
9. Нет интерфейсов для работы с хранилищем
10. Нет хелс-чеков. Невозможно понять текущее состояние сервиса
11. Не настроен graceful shutdown хотя бы по времени, не говоря уже про глобальный контекст приложения и гарантирования
    обработки всех запущенных внутренних горутин
12. Потенциальная гонка при бронировании. Две одинаковые брони на одни даты в одно время. Нет механизма блокировки,
    который позволит корректно обработать подобный кейс
13. Потенциальная гонка при расчете остатков, вероятно, на выходе мы получим некорреткные остатки спустя какое-то время
14. Нет транзакционности при расчете остатков (списали квоту на часть дней, уперлись в ошибку, но остатки не вернули, а
    бронь не создали)
15. Нет никаких метрик (количество запросов, время ответа запросов, бизнес-метрики, ...). Это сильно ограничивает
    понимание эффективности работы сервиса.
16. Нет авторизации (допускается, что авторизации за пределами сервиса)
17. Нет рейт-лимитеров на запросы по IP или другим признакам (допускается, что лимитеры есть за пределами сервиса)
18. Бизнес проблема: Нет ограничения на количество броней для одного пользователя, потенциально могут злонамеренно
    списать все остатки
19. Бизнес проблема: Не учитывается расчетный час заезда/выезда, ведь в 00 часов никто не заезжает. Это аффектит на
    формат данных в запросах и на логику расчета остатков
20. Бизнес проблема: Нет поддержки мультирума (бронь >1 комнаты). Техническая проблема - изменится структура входных
    данных на ручку orders, что повлечет глобальные изменения по всей структуре. Предлагается решение в виде нового
    эндпоинта /api/v2/orders, который будет поддерживать работу со множеством объектов

## Ключевые изменения в архитектуре

- Попытка реализовать луковую архитектуру для разделения приложения по слоям в сочетании с DDD и чистой архитектурой
- Применение фабричного паттерна для определения типа хранения данных
- Применены элементы паттерна сага для отката в случае неудачного действия с подтранзакциями (не реализация, а только
  элементы)

## Демо-стенд:

Сервис доступен по адресу: http://booker.ddns.net/
